<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Behavior Detection System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,0..200" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --secondary-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f77f00;
            --error-color: #e63946;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #212529;
            --text-secondary: #6c757d;
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1.2rem;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            height: 45px;
            margin-right: 1rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transition: transform var(--transition-speed);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        h1, h2, h3 {
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .grid-container {
                grid-template-columns: 3fr 2fr;
            }
        }

        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.8rem;
            margin-bottom: 2rem;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .video-container {
            height: 550px;
            display: flex;
            flex-direction: column;
        }

        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .video-feed {
            flex-grow: 1;
            background-color: #1a1a1a;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .video-feed img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-feed p {
            color: white;
            font-size: 1.2rem;
            text-align: center;
            padding: 2rem;
        }

        .video-feed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.7;
            pointer-events: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .switch-label {
            margin-left: 10px;
            font-weight: 500;
            transition: color var(--transition-speed);
        }

        input:checked ~ .switch-label {
            color: var(--primary-color);
        }

        .results-container {
            height: 550px;
            display: flex;
            flex-direction: column;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            margin: 1.2rem 0;
            border-radius: 2px;
        }

        .result-section {
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .emotion-display {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }

        .emotion-icon {
            font-size: 2.5rem;
            margin-right: 1rem;
            transition: transform var(--transition-speed);
        }

        .emotion-icon:hover {
            transform: scale(1.1);
        }

        .emotion-text {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .confidence-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .confidence-bar {
            height: 10px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chip {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-weight: 500;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all var(--transition-speed);
        }

        .chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .chip-neutral {
            background-color: #e9ecef;
            color: var(--text-color);
        }

        .chip-success {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .chip-warning {
            background-color: rgba(247, 127, 0, 0.15);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .alert {
            padding: 1.2rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            transition: all var(--transition-speed);
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .alert-error {
            background-color: rgba(230, 57, 70, 0.15);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .alert-icon {
            margin-right: 0.8rem;
            font-size: 1.8rem;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.03); }
            100% { opacity: 1; transform: scale(1); }
        }

        .footer-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: auto;
            padding-top: 1.5rem;
        }

        /* Info Card */
        .info-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--primary-color);
        }

        .info-card p {
            color: var(--text-secondary);
            margin-top: 1rem;
            line-height: 1.8;
        }

        /* Icons */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: 24px;
            background-repeat: no-repeat;
            background-position: center;
        }

        .material-icon {
            font-family: 'Material Symbols Rounded';
            font-size: 24px;
            font-weight: normal;
            font-style: normal;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
        }

        .icon-happy {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
        }

        .icon-happy::before {
            content: "sentiment_very_satisfied";
            font-family: 'Material Symbols Rounded';
        }

        .icon-sad {
            background-color: rgba(230, 57, 70, 0.15);
            color: var(--error-color);
        }

        .icon-sad::before {
            content: "sentiment_very_dissatisfied";
            font-family: 'Material Symbols Rounded';
        }

        .icon-neutral {
            background-color: rgba(67, 97, 238, 0.15);
            color: var(--primary-color);
        }

        .icon-neutral::before {
            content: "sentiment_neutral";
            font-family: 'Material Symbols Rounded';
        }

        .icon-warning {
            background-color: rgba(230, 57, 70, 0.15);
            color: var(--error-color);
        }

        .icon-warning::before {
            content: "warning";
            font-family: 'Material Symbols Rounded';
        }

        .icon-check {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
        }

        .icon-check::before {
            content: "check_circle";
            font-family: 'Material Symbols Rounded';
        }

        /* Loading animation */
        .loading-animation {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toggle Button */
        .toggle-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            border: none;
            border-radius: 50px;
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        
        .toggle-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .toggle-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .toggle-button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }
        
        .toggle-button .material-icon {
            font-size: 1.2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .video-container, .results-container {
                height: auto;
                min-height: 400px;
            }

            .video-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .video-header > div {
                align-self: flex-start;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .emotion-text {
                font-size: 1.5rem;
            }
            
            .toggle-button {
                font-size: 0.8rem;
                padding: 0.5rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/logo.svg" alt="Logo" class="logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\' width=\'45\' height=\'45\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%234361ee\' /%3E%3Ctext x=\'50\' y=\'60\' font-family=\'Arial\' font-size=\'40\' text-anchor=\'middle\' fill=\'white\'%3EH%3C/text%3E%3C/svg%3E'; this.onerror=null;">
            <h1>Human Behavior Detection System</h1>
        </div>
    </header>

    <div class="container">
        <div class="grid-container">
            <!-- Main content - Video Feed -->
            <div class="card video-container">
                <div class="video-header">
                    <h2>Live Detection Feed</h2>
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <div style="display: flex; align-items: center;">
                            <label class="switch">
                                <input type="checkbox" id="detectionToggle">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" id="toggleLabel">Detection Inactive</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <button id="faceMarkingsToggle" class="toggle-button" disabled>
                                <span class="material-icon">face</span>
                                <span>Show Face Markings</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="video-feed" id="videoFeed">
                    <p>Toggle the switch to start detection</p>
                </div>
            </div>

            <!-- Detection Results -->
            <div class="card results-container">
                <h2>Detection Results</h2>
                <div class="divider"></div>

                <!-- Emotion -->
                <div class="result-section">
                    <h3>Detected Emotion</h3>
                    <div class="emotion-display">
                        <span class="icon icon-neutral" id="emotionIcon"></span>
                        <span class="emotion-text" id="emotionText">None</span>
                    </div>
                    <p class="confidence-text" id="confidenceText">Confidence: 0.0%</p>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Expression -->
                <div class="result-section">
                    <h3>Facial Expression</h3>
                    <span class="chip chip-neutral" id="expressionChip">None</span>
                </div>

                <!-- Drowsiness Alert -->
                <div class="result-section">
                    <h3>Drowsiness Detection</h3>
                    <div class="alert alert-success" id="drowsyAlert">
                        <span class="icon icon-check"></span>
                        <span><strong>Alert and Attentive</strong></span>
                    </div>
                </div>

                <p class="footer-text">Results update in real-time when detection is active</p>
            </div>

            <!-- Information card -->
            <div class="card info-card">
                <h2>About Human Behavior Detection</h2>
                <p>
                    This application uses computer vision and machine learning to detect human emotions, expressions, and drowsiness in real-time.
                    The system can identify seven different emotions (Angry, Disgust, Fear, Happy, Sad, Surprise, Neutral) and detect facial expressions like smiles and yawns.
                    It also monitors eye movements to detect drowsiness, which can be useful for driver safety applications.
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const detectionToggle = document.getElementById('detectionToggle');
            const toggleLabel = document.getElementById('toggleLabel');
            const videoFeed = document.getElementById('videoFeed');
            const emotionIcon = document.getElementById('emotionIcon');
            const emotionText = document.getElementById('emotionText');
            const confidenceText = document.getElementById('confidenceText');
            const confidenceFill = document.getElementById('confidenceFill');
            const expressionChip = document.getElementById('expressionChip');
            const drowsyAlert = document.getElementById('drowsyAlert');
            const faceMarkingsToggle = document.getElementById('faceMarkingsToggle');
            
            // State
            let detectionActive = false;
            let faceMarkingsActive = false;
            let videoImg = null;
            let resultsFetchInterval = null;
            
            // Toggle detection
            detectionToggle.addEventListener('change', async function() {
                try {
                    // Show loading animation
                    videoFeed.innerHTML = '<div class="loading-animation"></div>';
                    
                    const response = await fetch('http://localhost:5000/api/toggle_detection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            active: this.checked
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'started' || data.status === 'stopped') {
                        detectionActive = this.checked;
                        updateUI();
                    }
                } catch (error) {
                    console.error('Error toggling detection:', error);
                    alert('Error connecting to the server. Please make sure the backend is running.');
                    this.checked = false;
                    detectionActive = false;
                    updateUI();
                }
            });
            
            // Toggle face markings
            faceMarkingsToggle.addEventListener('click', async function() {
                try {
                    faceMarkingsActive = !faceMarkingsActive;
                    
                    const response = await fetch('http://localhost:5000/api/toggle_face_markings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            show: faceMarkingsActive
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        updateFaceMarkingsButton();
                    }
                } catch (error) {
                    console.error('Error toggling face markings:', error);
                    faceMarkingsActive = false;
                    updateFaceMarkingsButton();
                }
            });
            
            // Update face markings button state
            function updateFaceMarkingsButton() {
                if (faceMarkingsActive) {
                    faceMarkingsToggle.classList.add('active');
                    faceMarkingsToggle.innerHTML = `
                        <span class="material-icon">face</span>
                        <span>Hide Face Markings</span>
                    `;
                } else {
                    faceMarkingsToggle.classList.remove('active');
                    faceMarkingsToggle.innerHTML = `
                        <span class="material-icon">face</span>
                        <span>Show Face Markings</span>
                    `;
                }
            }
            
            // Update UI based on detection state
            function updateUI() {
                toggleLabel.textContent = detectionActive ? 'Detection Active' : 'Detection Inactive';
                
                // Enable/disable face markings toggle based on detection state
                faceMarkingsToggle.disabled = !detectionActive;
                
                if (detectionActive) {
                    // Load video feed
                    videoFeed.innerHTML = '';
                    videoImg = document.createElement('img');
                    videoImg.src = `http://localhost:5000/video_feed?t=${Date.now()}`;
                    videoImg.alt = 'Live Detection Feed';
                    videoImg.style.maxWidth = '100%';
                    videoImg.style.maxHeight = '100%';
                    videoImg.style.objectFit = 'contain';
                    
                    videoImg.onerror = function(e) {
                        console.error('Error loading video feed:', e);
                        setTimeout(() => {
                            if (detectionActive) {
                                videoImg.src = `http://localhost:5000/video_feed?t=${Date.now()}`;
                            }
                        }, 1000);
                    };
                    
                    videoFeed.appendChild(videoImg);
                    
                    // Start fetching results
                    fetchResults();
                    resultsFetchInterval = setInterval(fetchResults, 1000);
                } else {
                    // Clear video feed
                    videoFeed.innerHTML = '<p>Toggle the switch to start detection</p>';
                    videoImg = null;
                    
                    // Reset face markings state
                    faceMarkingsActive = false;
                    updateFaceMarkingsButton();
                    
                    // Reset result displays
                    emotionIcon.className = 'icon icon-neutral';
                    emotionText.textContent = 'None';
                    confidenceText.textContent = 'Confidence: 0.0%';
                    confidenceFill.style.width = '0%';
                    expressionChip.textContent = 'None';
                    expressionChip.className = 'chip chip-neutral';
                    drowsyAlert.className = 'alert alert-success';
                    drowsyAlert.innerHTML = `
                        <span class="icon icon-check"></span>
                        <span><strong>Alert and Attentive</strong></span>
                    `;
                    
                    // Stop fetching results
                    if (resultsFetchInterval) {
                        clearInterval(resultsFetchInterval);
                        resultsFetchInterval = null;
                    }
                }
            }
            
            // Fetch detection results
            async function fetchResults() {
                try {
                    const response = await fetch('http://localhost:5000/api/detection_status');
                    const data = await response.json();
                    
                    // Update emotion with animation
                    const oldEmotion = emotionText.textContent;
                    if (oldEmotion !== data.emotion) {
                        emotionText.style.opacity = 0;
                        setTimeout(() => {
                            emotionText.textContent = data.emotion;
                            emotionText.style.opacity = 1;
                        }, 300);
                    } else {
                        emotionText.textContent = data.emotion;
                    }
                    
                    confidenceText.textContent = `Confidence: ${(data.emotion_prob * 100).toFixed(1)}%`;
                    confidenceFill.style.width = `${data.emotion_prob * 100}%`;
                    
                    // Update emotion icon
                    emotionIcon.className = 'icon';
                    if (['Happy', 'Surprise'].includes(data.emotion)) {
                        emotionIcon.classList.add('icon-happy');
                    } else if (['Angry', 'Disgust', 'Fear', 'Sad'].includes(data.emotion)) {
                        emotionIcon.classList.add('icon-sad');
                    } else {
                        emotionIcon.classList.add('icon-neutral');
                    }
                    
                    // Update expression
                    expressionChip.textContent = data.expression;
                    expressionChip.className = 'chip';
                    if (data.expression === 'Smile') {
                        expressionChip.classList.add('chip-success');
                    } else if (data.expression === 'Yawn') {
                        expressionChip.classList.add('chip-warning');
                    } else {
                        expressionChip.classList.add('chip-neutral');
                    }
                    
                    // Update drowsiness
                    if (data.drowsy) {
                        drowsyAlert.className = 'alert alert-error pulse';
                        drowsyAlert.innerHTML = `
                            <span class="icon icon-warning"></span>
                            <span><strong>DROWSY ALERT!</strong></span>
                        `;
                    } else {
                        drowsyAlert.className = 'alert alert-success';
                        drowsyAlert.innerHTML = `
                            <span class="icon icon-check"></span>
                            <span><strong>Alert and Attentive</strong></span>
                        `;
                    }
                    
                    // Update face markings state if it changed from backend
                    if (faceMarkingsActive !== data.show_face_markings) {
                        faceMarkingsActive = data.show_face_markings;
                        updateFaceMarkingsButton();
                    }
                    
                } catch (error) {
                    console.error('Error fetching detection status:', error);
                }
            }
        });
    </script>
</body>
</html>